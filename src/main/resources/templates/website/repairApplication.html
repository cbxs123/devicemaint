<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
  <title>个人中心-维修申请</title>
  <link th:href="@{/lib/layui/css/layui.css}" rel="stylesheet">
  <link th:href="@{/css/index.css}" rel="stylesheet">
  <link th:href="@{/css/jquery-ui.css}" rel="stylesheet">
  
  <script th:src="@{/js/jquery.js}"></script>
  <script th:src="@{/js/jquery-ui.js}"></script>
  <script th:src="@{/lib/layui/layui.js}"></script>
  <script th:src="@{/js/common.js}"></script>
  
</head>
<body>
  <div class="layui-container" style="padding-top:40px;">
  	  <div class="personInfoPanel layui-col-md7 layui-col-gl7 layui-col-md-offset2 layui-col-gl-offset2">
  	  	<fieldset class="layui-elem-field layui-field-title">
		  <legend>维修申请</legend>
		</fieldset>
  	  	<form class="layui-form">
  	  	  <div class="layui-form-item">
  	  	    <div class="layui-input-inline">
		        <input type="hidden" id="companyId" name="companyId" placeholder="公司ID" class="layui-input">
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">公司名称</label>
		      <div class="layui-input-inline">
		        <input type="text" id="companyName" name="companyName" lay-verify="required" autocomplete="off" placeholder="公司名称" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">公司联系人</label>
		      <div class="layui-input-inline">
		        <input type="text" id="companyContact" name="companyContact" lay-verify="required" autocomplete="off" placeholder="公司联系人" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">公司电话</label>
		      <div class="layui-input-inline">
		        <input type="text" id="companyPhone" name="companyPhone" lay-verify="required" autocomplete="off" placeholder="公司电话" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">公司邮箱</label>
		      <div class="layui-input-inline">
		        <input type="text" id="companyEmail" name="companyEmail" lay-verify="required" autocomplete="off" placeholder="公司邮箱" class="layui-input">
		      </div>
		    </div>
		  </div>
		  <div class="layui-form-item">
		      <label class="layui-form-label">公司地址</label>
		      <div class="layui-input-block">
		        <input type="text" id="companyAddress" name="companyAddress" lay-verify="required" autocomplete="off" placeholder="公司地址" class="layui-input">
		      </div>
		  </div>
		  
		  <div class="layui-form-item">
		    <div class="layui-input-inline">
		        <input type="hidden" id="deviceId" name="deviceId" placeholder="设备ID" class="layui-input">
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">设备名</label>
		      <div class="layui-input-inline">
		        <input type="text" id="deviceName" name="deviceName" lay-verify="required" autocomplete="off" placeholder="设备名" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">设备型号</label>
		      <div class="layui-input-inline">
		        <input type="text" id="serialNumber" name="serialNumber" lay-verify="required" autocomplete="off" placeholder="设备型号" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">设备编号</label>
		      <div class="layui-input-inline">
		        <input type="text" id="deviceCode" name="deviceCode" lay-verify="required" autocomplete="off" placeholder="设备编码" class="layui-input">
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">设备品牌</label>
		      <div class="layui-input-inline">
		        <select name="deviceBrand" id="deviceBrand" lay-verify="required" lay-search>
			        <option value="">请选择设备品牌</option>
			        <option th:each="brand:${brands}" th:value="${brand.brandId}"
							th:text="${brand.brandName}"></option>
			     </select>
		      </div>
		    </div>
		    <div class="layui-inline">
		      <label class="layui-form-label">使用年限</label>
		      <div class="layui-input-inline">
		        <input type="text" id="deviceYears" name="deviceYears" lay-verify="number" autocomplete="off" placeholder="使用年限" class="layui-input">
		      </div>
		    </div>
		  </div>
		  
		  <div class="layui-form-item">
		      <label class="layui-form-label">联系人</label>
		      <div class="layui-input-block">
		        <input type="text" name="contact" lay-verify="required" autocomplete="off" placeholder="维修地点" class="layui-input">
		      </div>
		  </div>
		  <div class="layui-form-item">
		      <label class="layui-form-label">联系电话</label>
		      <div class="layui-input-block">
		        <input type="text" name="phone" lay-verify="required" autocomplete="off" placeholder="维修地点" class="layui-input">
		      </div>
		  </div>
		  <div class="layui-form-item">
		      <label class="layui-form-label">维修地点</label>
		      <div class="layui-input-block">
		        <input type="text" name="address" lay-verify="required" autocomplete="off" placeholder="维修地点" class="layui-input">
		      </div>
		  </div>
		  
		  <div class="layui-form-item layui-form-text">
		    <label class="layui-form-label">故障描述</label>
		    <div class="layui-input-block">
		      <textarea name="faultDescription" placeholder="请输入内容" class="layui-textarea"></textarea>
		    </div>
		  </div>
		  
		  <div class="layui-form-item">
		    <div class="layui-input-block">
		      <button type="submit" class="layui-btn" lay-submit lay-filter="repairApplicationForm">立即申请</button>
		    </div>
		  </div>
		</form>
  	  </div>
  </div>
  
  <script th:inline="javascript">
  $(document).ready(function() {
	  $( "#deviceName" ).autocomplete({
  		minLength: 1,
  	    source: [],
  	    focus: function( event, ui ) {
  	        $( this ).val( ui.item.label );
  	        return false;
  	    },
  	    select: function (event, ui) {
  	    	event.preventDefault();
  	    	$( this ).val( ui.item.label );
  	    	$("#deviceId").val(ui.item.deviceId);
  	    	$("#serialNumber").val(ui.item.serialNumber);
  	    	$("#deviceCode").val(ui.item.code);
    	    //$("#deviceBrand option[value="+ui.item.brandId+"]").prop("selected", true);
    	    $("#deviceYears").val(ui.item.years);
    	    $("#address").val(ui.item.address);
			
  	        return false;
  	    }
  	  }).autocomplete( "instance" )._renderItem = function( ul, item ) {
  	      return $( "<li>" )
  	      	.attr( "data-value", item)
  	        .append( "<div>" + item.label + "</div>" )
  	        .appendTo( ul );
  	    };
	  
	  $( "#companyName" ).autocomplete({
  		minLength: 1,
  	    source: [],
  	    focus: function( event, ui ) {
  	        $( this ).val( ui.item.label );
  	        return false;
  	    },
  	    select: function (event, ui) {
  	    	event.preventDefault();
  	    	$(this).val(ui.item.label);
  	    	$("#companyId").val(ui.item.companyId);
  	    	$("#companyContact").val(ui.item.contact);
	    	$("#companyPhone").val(ui.item.phone);
	    	$("#companyEmail").val(ui.item.email);
	    	$("#companyAddress").val(ui.item.companyAddress);
	    	
	    	$.ajax({
		        type: "POST",
			    data: "companyId="+ui.item.companyId,
			    dataType: "json",
		        url: "/website/user/getDevices",
		        async: false,
		        success:function(responseData){
		        	if(responseData.code == 0){
		        		$("#deviceName").autocomplete( "option", "source", responseData.data );
		        	}
		     	},
		     	error: function () {}
		    });
				
  	        return false;
  	    }
  	  }).autocomplete( "instance" )._renderItem = function( ul, item ) {
  	      return $( "<li>" )
  	      	.attr( "data-value", item)
  	        .append( "<div>" + item.label + "</div>" )
  	        .appendTo( ul );
  	    };
  	    
  	  $.ajax({
	        type: "POST",
		    data: "",
		    dataType: "json",
	        url: "/website/user/getCompanies",
	        async: false,
	        contentType: "application/json",
	        success:function(responseData){
	        	if(responseData.code == 0){
	        		$( "#companyName" ).autocomplete( "option", "source", responseData.data );
	        	}
	     	},
	     	error: function () {}
	  });
  });
    layui.use(['form','layer'], function(){
	  var form = layui.form
	  ,layer = layui.layer;
	  
	  //监听提交
	  form.on('submit(repairApplicationForm)', function(data){
		  $.ajax({
		        type: "POST",
			    data: JSON.stringify(data.field),
			    dataType: "json",
		        url: "/website/user/repairApplicationSave",
		        async: false,
		        contentType: "application/json",
		        success:function(data){
		        	if(data.code == 0){
		        		layer.alert(data.msg, {icon: 1});
		        		window.location.href="/website/user/toRepairApplication";
		        	}else{
		        		layer.alert(data.msg, {icon: 2});
		        	}
		     	},
		     	error: function () {
		     		layer.alert("维修申请失败", {icon: 2});
			 	}
		    });
	  });
	});
  </script>
</body>
</html>